<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enggano Island - Regional Coral Health Dashboard</title>
    
    <!-- CSS & JS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Teko:wght@500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f4f8; }
        .font-header { font-family: 'Teko', sans-serif; }
        #map { height: 100%; width: 100%; border-radius: 0.75rem; z-index: 1; }
        .leaflet-tooltip { background-color: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; border-radius: 4px; padding: 4px 8px; font-weight: 600; color: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .sort-icon { display: inline-block; width: 1em; height: 1em; margin-left: 0.5em; opacity: 0.4; }
        .th-sortable { cursor: pointer; }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 lg:p-6">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="font-header text-5xl md:text-6xl font-semibold text-slate-700 tracking-wide">ENGGANO REEF DASHBOARD</h1>
            <p class="text-slate-500 text-lg">Regional Coral & Rubble Area Analysis (2011-2021)</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-lg h-[60vh] lg:h-[calc(100vh-140px)]">
                <div id="map"></div>
            </div>
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div id="info-panel" class="bg-white p-6 rounded-xl shadow-lg flex-grow">
                    <div class="flex justify-between items-center border-b-2 border-slate-200 pb-2 mb-4">
                        <h2 id="stats-title" class="font-header text-3xl font-semibold">Region Statistics</h2>
                        <button id="show-overall-btn" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-1 px-3 rounded-lg transition duration-300" style="display: none;">Show Overall</button>
                    </div>
                    <div id="info-content" class="text-slate-600">
                        <p class="text-center py-8">Loading statistics...</p>
                    </div>
                </div>
                <div id="chart-panel" class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center border-b-2 border-slate-200 pb-2 mb-4">
                        <h2 id="chart-title" class="font-header text-3xl font-semibold text-center"></h2>
                        <button id="export-chart-btn" class="text-sm bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Save as PNG</button>
                    </div>
                    <div><canvas id="timeSeriesChart"></canvas></div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="font-header text-4xl font-semibold text-center">Complete Regional Data</h2>
                 <button id="export-table-btn" class="text-sm bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Export to CSV</button>
            </div>
             <div class="overflow-x-auto max-h-96">
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-slate-50 sticky top-0">
                        <tr>
                            <th class="th-sortable px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-sort="Year">Year <span class="sort-icon"></span></th>
                            <th class="th-sortable px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-sort="Region">Region <span class="sort-icon"></span></th>
                            <th class="th-sortable px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-sort="Coral Area (km²)">Coral Area (km²) <span class="sort-icon"></span></th>
                            <th class="th-sortable px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-sort="Rubble Area (km²)">Rubble Area (km²) <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                 </table>
             </div>
        </div>
    </div>

    <script>
    // --- GLOBAL STATE & ICONS ---
    let timeSeriesChart;
    let fullDataset = [];
    let overallEngganoData = [];
    const sortIcons = {
        none: '&#x2195;', asc: '&#x2191;', desc: '&#x2193;'
    };
    let currentSort = { column: 'Year', order: 'asc' };

    // --- DATA LOADING & INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', initializeDashboard);

    async function initializeDashboard() {
        try {
            const [allDataResponse, statsDataResponse, geojsonResponse] = await Promise.all([
                fetch('./data/all_data.csv'),
                fetch('./data/stats_summary.csv'),
                fetch('./data/regions.geojson')
            ]);
            
            const allDataText = await allDataResponse.text();
            const statsDataText = await statsDataResponse.text();
            const geojsonData = await geojsonResponse.json();

            // Use PapaParse with skipEmptyLines to prevent errors from trailing newlines in CSV files
            fullDataset = Papa.parse(allDataText, { header: true, dynamicTyping: true, skipEmptyLines: true }).data;
            const statsData = Papa.parse(statsDataText, { header: true, dynamicTyping: true, skipEmptyLines: true }).data;
            overallEngganoData = fullDataset.filter(d => d.Region === 'Enggano');
            
            buildPage(fullDataset, statsData, geojsonData);

        } catch (error) {
            console.error("Failed to load data:", error);
            document.body.innerHTML = `<div class="text-center p-10"><h1>Error loading data</h1><p>Could not load necessary data files from the 'data' folder. Please ensure they exist and the server is running correctly.</p><p>Error: ${error}</p></div>`;
        }
    }

    function buildPage(allData, statsData, geojsonData) {
        const map = L.map('map').setView([-5.38, 102.25], 10.5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        }).addTo(map);

        const tableHeaders = document.querySelectorAll('.th-sortable');
        
        function populateTable(data) {
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = '';
            // Filter out the overall Enggano data and any malformed rows from the main table view
            data.filter(row => row && row.Region && row.Region !== 'Enggano').forEach(row => {
                const tr = document.createElement('tr');
                // Safely handle potential non-numeric data before calling toFixed()
                const coralArea = typeof row['Coral Area (km²)'] === 'number' ? row['Coral Area (km²)'] : 0;
                const rubbleArea = typeof row['Rubble Area (km²)'] === 'number' ? row['Rubble Area (km²)'] : 0;
                tr.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-slate-900">${row.Year}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-600">${row.Region}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-500">${coralArea.toFixed(6)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-500">${rubbleArea.toFixed(6)}</td>`;
                tableBody.appendChild(tr);
            });
        }

        function updateSortIcons() {
            tableHeaders.forEach(header => {
                const sortKey = header.getAttribute('data-sort');
                const icon = header.querySelector('.sort-icon');
                if (sortKey === currentSort.column) {
                    icon.innerHTML = sortIcons[currentSort.order];
                    icon.style.opacity = '1';
                } else {
                    icon.innerHTML = sortIcons.none;
                    icon.style.opacity = '0.4';
                }
            });
        }
        
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.getAttribute('data-sort');
                if (currentSort.column === sortKey) {
                    currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = sortKey;
                    currentSort.order = 'asc';
                }
                
                fullDataset.sort((a, b) => {
                    const valA = a[currentSort.column];
                    const valB = b[currentSort.column];
                    let comparison = 0;
                    if (valA > valB) comparison = 1;
                    else if (valA < valB) comparison = -1;
                    return currentSort.order === 'desc' ? comparison * -1 : comparison;
                });
                
                populateTable(fullDataset);
                updateSortIcons();
            });
        });
        
        const chartCanvas = document.getElementById('timeSeriesChart').getContext('2d');
        
        function createOrUpdateChart(regionName) {
            const chartPanel = document.getElementById('chart-panel');
            const regionData = fullDataset.filter(d => d.Region === regionName);
            if (!regionData.length) {
                chartPanel.style.display = 'none';
                return;
            }
            chartPanel.style.display = 'block';

            const years = [...new Set(regionData.map(d => d.Year))].sort((a,b) => a-b);
            const coralData = years.map(year => regionData.find(d => d.Year === year)['Coral Area (km²)']);
            const rubbleData = years.map(year => regionData.find(d => d.Year === year)['Rubble Area (km²)']);

            document.getElementById('chart-title').innerText = `${regionName} Trends`;
            if (timeSeriesChart) timeSeriesChart.destroy();

            timeSeriesChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        { label: 'Coral Area (km²)', data: coralData, borderColor: '#0e7490', backgroundColor: 'rgba(14, 116, 144, 0.1)', tension: 0.3, fill: true },
                        { label: 'Rubble Area (km²)', data: rubbleData, borderColor: '#ea580c', backgroundColor: 'rgba(234, 88, 12, 0.1)', tension: 0.3, fill: true }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Area (km²)' } } } }
            });
        }

        const infoContent = document.getElementById('info-content');
        
        function updateInfoPanel(regionName, data) {
             const statsTitle = document.getElementById('stats-title');
             const showOverallBtn = document.getElementById('show-overall-btn');

             statsTitle.innerText = `${regionName} Statistics`;
             
             // Filter for valid numbers before calculating stats
             const coralValues = data.map(d => d['Coral Area (km²)']).filter(v => typeof v === 'number');
             const rubbleValues = data.map(d => d['Rubble Area (km²)']).filter(v => typeof v === 'number');
             
             const meanCoral = coralValues.length ? coralValues.reduce((a, b) => a + b, 0) / coralValues.length : 0;
             const minCoral = coralValues.length ? Math.min(...coralValues) : 0;
             const maxCoral = coralValues.length ? Math.max(...coralValues) : 0;
             
             const meanRubble = rubbleValues.length ? rubbleValues.reduce((a, b) => a + b, 0) / rubbleValues.length : 0;
             const minRubble = rubbleValues.length ? Math.min(...rubbleValues) : 0;
             const maxRubble = rubbleValues.length ? Math.max(...rubbleValues) : 0;
             
             infoContent.innerHTML = `
                <div class="mt-4 space-y-3">
                    <div>
                        <h4 class="font-semibold text-cyan-700">Coral Reef Area (km²)</h4>
                        <ul class="list-disc list-inside text-sm pl-2">
                            <li><strong>Mean:</strong> ${meanCoral.toFixed(6)}</li>
                            <li><strong>Min:</strong> ${minCoral.toFixed(6)}</li>
                            <li><strong>Max:</strong> ${maxCoral.toFixed(6)}</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold text-orange-600">Rubble Area (km²)</h4>
                        <ul class="list-disc list-inside text-sm pl-2">
                            <li><strong>Mean:</strong> ${meanRubble.toFixed(6)}</li>
                            <li><strong>Min:</strong> ${minRubble.toFixed(6)}</li>
                            <li><strong>Max:</strong> ${maxRubble.toFixed(6)}</li>
                        </ul>
                    </div>
                </div>`;
            createOrUpdateChart(regionName);
            showOverallBtn.style.display = regionName === 'Enggano' ? 'none' : 'inline-block';
        }

        let geojsonLayer;
        
        function onFeatureClick(e) {
            const regionName = e.target.feature.properties.name;
            const regionData = allData.filter(d => d.Region === regionName);
            if(regionData.length > 0){
                updateInfoPanel(regionName, regionData);
            }
            map.fitBounds(e.target.getBounds());
        }

        geojsonLayer = L.geoJSON(geojsonData, {
            style: { color: '#0e7490', weight: 2, opacity: 0.8, fillColor: '#67e8f9', fillOpacity: 0.3 },
            onEachFeature: (feature, layer) => {
                layer.on({
                    mouseover: e => e.target.setStyle({ weight: 4, color: '#0891b2', fillOpacity: 0.5 }).bringToFront(),
                    mouseout: e => geojsonLayer.resetStyle(e.target),
                    click: onFeatureClick
                });
                layer.bindTooltip(feature.properties.name, { permanent: false, direction: 'center', className: 'leaflet-tooltip' });
            }
        }).addTo(map);
        map.fitBounds(geojsonLayer.getBounds());
        
        document.getElementById('show-overall-btn').addEventListener('click', () => {
            updateInfoPanel('Enggano', overallEngganoData);
            map.fitBounds(geojsonLayer.getBounds());
        });

        // --- EXPORT FUNCTIONS ---
        document.getElementById('export-chart-btn').addEventListener('click', () => {
            if (timeSeriesChart) {
                const link = document.createElement('a');
                link.href = timeSeriesChart.toBase64Image();
                link.download = `${document.getElementById('chart-title').innerText.replace(' Trends', '')}-chart.png`;
                link.click();
            }
        });
        
        document.getElementById('export-table-btn').addEventListener('click', () => {
            // Exclude the 'Enggano' overall data from the CSV export
            const exportData = fullDataset.filter(row => row.Region !== 'Enggano');
            const csv = Papa.unparse(exportData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'enggano_regional_data.csv');
            link.click();
        });

        // --- INITIALIZE PAGE ---
        populateTable(allData);
        updateSortIcons();
        updateInfoPanel('Enggano', overallEngganoData);
    }
    </script>
</body>
</html>

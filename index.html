<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enggano Island - Regional Coral Health Dashboard</title>
    
    <!-- CSS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- JS Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Teko:wght@500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f4f8; }
        .font-header { font-family: 'Teko', sans-serif; }
        #map { height: 100%; width: 100%; border-radius: 0.75rem; z-index: 1; }
        .leaflet-tooltip { background-color: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; border-radius: 4px; padding: 4px 8px; font-weight: 600; color: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 lg:p-6">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="font-header text-5xl md:text-6xl font-semibold text-slate-700 tracking-wide">ENGGANO REEF DASHBOARD</h1>
            <p class="text-slate-500 text-lg">Regional Coral & Rubble Area Analysis (2011-2021)</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-lg h-[60vh] lg:h-[calc(100vh-140px)]">
                <div id="map"></div>
            </div>
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div id="info-panel" class="bg-white p-6 rounded-xl shadow-lg flex-grow">
                    <h2 class="font-header text-3xl font-semibold border-b-2 border-slate-200 pb-2 mb-4">Region Statistics</h2>
                    <div id="info-content" class="text-slate-600">
                        <p class="text-center py-8">Click on a region on the map to view its detailed statistics.</p>
                    </div>
                </div>
                <div id="chart-container" class="bg-white p-6 rounded-xl shadow-lg" style="display: none;">
                    <h2 id="chart-title" class="font-header text-3xl font-semibold border-b-2 border-slate-200 pb-2 mb-4 text-center"></h2>
                    <div><canvas id="timeSeriesChart"></canvas></div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 bg-white p-6 rounded-xl shadow-lg">
             <h2 class="font-header text-4xl font-semibold text-center mb-4">Complete Regional Data</h2>
             <div class="overflow-x-auto max-h-96">
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Year</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Region</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Coral Area (km²)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Rubble Area (km²)</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                 </table>
             </div>
        </div>
    </div>

    <script>
    // --- DATA LOADING AND DASHBOARD LOGIC ---

    // Helper function to parse CSV text into an array of objects
    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
            const values = line.split(',');
            return headers.reduce((obj, header, index) => {
                const value = values[index].trim();
                obj[header] = isNaN(value) || value === '' ? value : Number(value);
                return obj;
            }, {});
        });
    }

    // Load all data files asynchronously
    Promise.all([
        fetch('./data/all_data.csv').then(response => response.text()),
        fetch('./data/stats_summary.csv').then(response => response.text()),
        fetch('./data/regions.geojson').then(response => response.json())
    ]).then(([allDataCSV, statsDataCSV, geojsonData]) => {

        // Parse the CSV data
        const allData = parseCSV(allDataCSV);
        const statsData = parseCSV(statsDataCSV);

        // --- MAP INITIALIZATION ---
        const map = L.map('map').setView([-5.38, 102.25], 10.5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        }).addTo(map);

        // --- CHART INITIALIZATION ---
        let timeSeriesChart;
        const chartCanvas = document.getElementById('timeSeriesChart').getContext('2d');
        
        function createOrUpdateChart(regionName) {
            const regionData = allData.filter(d => d.Region === regionName);
            const years = regionData.map(d => d.Year).sort();
            const coralData = regionData.sort((a,b) => a.Year - b.Year).map(d => d['Coral Area (km²)']);
            const rubbleData = regionData.sort((a,b) => a.Year - b.Year).map(d => d['Rubble Area (km²)']);

            document.getElementById('chart-container').style.display = 'block';
            document.getElementById('chart-title').innerText = `${regionName} Trends`;
            if (timeSeriesChart) timeSeriesChart.destroy();

            timeSeriesChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        { label: 'Coral Area (km²)', data: coralData, borderColor: '#0e7490', backgroundColor: 'rgba(14, 116, 144, 0.1)', tension: 0.3, fill: true },
                        { label: 'Rubble Area (km²)', data: rubbleData, borderColor: '#ea580c', backgroundColor: 'rgba(234, 88, 12, 0.1)', tension: 0.3, fill: true }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Area (km²)' } } } }
            });
        }

        // --- INTERACTIVITY LOGIC ---
        const infoContent = document.getElementById('info-content');
        let geojsonLayer;

        function highlightFeature(e) {
            e.target.setStyle({ weight: 4, color: '#0891b2', fillOpacity: 0.5 }).bringToFront();
        }

        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
        }
        
        function onFeatureClick(e) {
            const regionName = e.target.feature.properties.name;
            const stats = statsData.find(d => d.Region === regionName);

            if (stats) {
                infoContent.innerHTML = `
                    <h3 class="font-header text-2xl font-semibold text-slate-700">${stats.Region}</h3>
                    <div class="mt-4 space-y-3">
                        <div>
                            <h4 class="font-semibold text-cyan-700">Coral Reef Area (km²)</h4>
                            <ul class="list-disc list-inside text-sm pl-2">
                                <li><strong>Mean:</strong> ${stats.Mean_Coral_Area_km2.toFixed(4)}</li>
                                <li><strong>Min:</strong> ${stats.Min_Coral_Area_km2.toFixed(4)}</li>
                                <li><strong>Max:</strong> ${stats.Max_Coral_Area_km2.toFixed(4)}</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-orange-600">Rubble Area (km²)</h4>
                            <ul class="list-disc list-inside text-sm pl-2">
                                <li><strong>Mean:</strong> ${stats.Mean_Rubble_Area_km2.toFixed(4)}</li>
                                <li><strong>Min:</strong> ${stats.Min_Rubble_Area_km2.toFixed(4)}</li>
                                <li><strong>Max:</strong> ${stats.Max_Rubble_Area_km2.toFixed(4)}</li>
                            </ul>
                        </div>
                    </div>`;
                createOrUpdateChart(regionName);
            }
            map.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: onFeatureClick });
            layer.bindTooltip(feature.properties.name, { permanent: false, direction: 'center', className: 'leaflet-tooltip' });
        }

        geojsonLayer = L.geoJSON(geojsonData, {
            style: { color: '#0e7490', weight: 2, opacity: 0.8, fillColor: '#67e8f9', fillOpacity: 0.3 },
            onEachFeature: onEachFeature
        }).addTo(map);
        
        map.fitBounds(geojsonLayer.getBounds());

        // --- DATA TABLE POPULATION ---
        const tableBody = document.getElementById('data-table-body');
        allData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-slate-900">${row.Year}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-600">${row.Region}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-500">${row['Coral Area (km²)'].toFixed(4)}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-500">${row['Rubble Area (km²)'].toFixed(4)}</td>`;
            tableBody.appendChild(tr);
        });

    }).catch(error => {
        console.error('Error loading data:', error);
        document.body.innerHTML = `<div class="text-center p-10"><h1>Error loading data</h1><p>Could not load data files. If you are viewing this locally, ensure you are running a local web server due to CORS policy.</p><p>Error: ${error}</p></div>`;
    });
    </script>
</body>
</html>
